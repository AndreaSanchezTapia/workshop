var cerrado = ee.FeatureCollection("users/lucasljardim9/wwf_cerrado");

var dataset = ee.Image("MERIT/DEM/v1_0_3").clip(cerrado);

var neighbor = dataset.neighborhoodToBands(ee.Kernel.square(1));

var elevation_max = neighbor.reduce(ee.Reducer.max());

var elevation_min = neighbor.reduce(ee.Reducer.min());

var elevation_range = elevation_max.subtract(elevation_min).abs();

var elevation = ee.Image.cat(dataset, elevation_range)
                 .rename(['elevation', 'elevation_range']);
                 
var regression = elevation.reduceRegion({
     reducer: ee.Reducer.linearFit(),
     geometry: cerrado,
     maxPixels: 463690740
    });
    
var pred = elevation.select('elevation').multiply(ee.Number(regression.get('scale')));

var predict = pred.add(ee.Number(regression.get('offset')));

var residuals = elevation.select('elevation_range').subtract(predict).rename(['residuals']);

Export.image.toDrive({
  image: residuals,
  description: 'elevation_range_residual',
  scale: 92.76624,
  region: cerrado,
  maxPixels: 463690740});

/*
var sample = ee.FeatureCollection.randomPoints({
               region: cerrado,
               points: 5000
             });
             
var plot_image = ee.Image.cat(residuals, elevation.select('elevation'))
                 .sampleRegions({collection: sample});  


var chart = ui.Chart.feature.byFeature(plot_image, 'elevation', ['residuals'])
  .setChartType('ScatterChart');
  
  print(chart);

*/