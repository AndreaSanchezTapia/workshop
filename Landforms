/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var geometry = 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[-47.18609379882812, -14.073424596661212],
          [-47.18609379882812, -14.092072837313145],
          [-47.16103123779296, -14.092072837313145],
          [-47.16103123779296, -14.073424596661212]]], null, false);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
/**
 * This script generates and exports to Google Drive a raster of landform varieties at a scale of ~ 90 m for a biome.  
*/

/* Steps to calculate landform variety

1- Calculate relief slopes, aspects and Topographic Position Index (TPI) from a Digital Elevation Model.

2- Calculate a moisture index from a flow accumulation raster and slopes.

3- Transform slopes, aspect, TPI and moisture index into classes

4- Combine slopes, aspect, TPI and moisture classes into a code string

5- Re-classify landform string into landform types

6- Count the number of distinct landforms within a focal cell kernel (landform variety)

7- Export landform variety raster

*/

/*
First, we import a shapefile of brazilian biomes from IBGE (2018) and filter a biome to mask the rasters.
*/

var bioma = ee.FeatureCollection("projects/ee-lucasljardim9/assets/Biome")
                       .select("Bioma")
                       .filter(ee.Filter.eq("Bioma", "Cerrado"));
                       
/*
Then, we import a Digital Elevation Model from Merit-DEM (...) at a scale of ~ 90 meters. 
This raster solves problems of elevation estimates in flat regions and places with high density of wetlands.
We clip the raster by the biome mask.
*/

var DEM = ee.Image("MERIT/DEM/v1_0_3")
          .clip(bioma);

/*
Also, we import Merit-Hydro raster (..), which has a layer of flow accumulation derived from the above cited Merit-DEM. 
This raster avoids issues related to calculate flow accumulation from flat areas. Additionally, this raster avoid a concern
of calculating flow direction and flow accumulation for biomes without taking into account the whole basin flow.
*/

var flow_accumulation = ee.Image("MERIT/Hydro/v1_0_1")
    .select("upg")
    .clip(bioma);
    
/* 
We calculate relief slopes and aspect based on the DEM. 
*/

var slope = ee.Terrain.slope(DEM);

var aspect = ee.Terrain.aspect(DEM);

/*
Here we calculate a moisture index (..) based on the flow accumulation and slopes.
A focal mean is calculated around the cells to smooth the index. The focal mean 
is calculated around a neighborhood of 3 cells with a circle kernel.

Moisture index = log((flow_accumulation + 1) / (slope + 1)) * 1000
*/

var moisture_index = flow_accumulation.
                     add(ee.Number(1))
                     .divide(slope.add(ee.Number(1)))
                     .log()
                     .multiply(1000)
                     .focalMean({
                       radius: 3,
                       kernelType: "circle",
                       units: "pixels"
                     });
                     
/* Here we calculate a Topographic Position Index (TPI) (..). We create a function to calculate TPI 
for a circular kernels of different sizes. Then, we took the average TPI to compose an index 
that considers the landscape influence at multiple scale (Theobald..).

TPI = sum(elevation_neighborhood -  focal_elevation) / number of neighborhood cells

We define the neighborhood by a circular kernel. 

The original TNC script used an annulus (torus) kernel to calculate the Land Position Index (LPI). It was required 
to weight elevation differences by their geographical distances.

LPI = sum((elevation_neighborhood -  focal_elevation) / cell distance) / number of neighborhood cells

Annulus kernel is not implemented yet on GEE, we may implement a function to calculate it in the future to calculate LPI.
*/


/**
 * Function to calculate Topographic Position Index (TPI) within a circle kernel of a specific size. 
 * @param Kernel size in pixel units.
 * @results An image of TPI values.
*/

var calculate_TPI = function(pixel_size){
  
// Split neighborhood cells within a circles kernel into bands

var focal_mean = DEM.focalMean({
                       radius: pixel_size,
                       kernelType: "circle",
                       units: "pixels"
                     });

// Calculate neighborhood differences to the focal cells and take the mean
TPI = focal_mean.subtract(DEM)

return TPI;
}

// 50 cells identify high elevation areas and plateaus

// 10

var window_size = [1, 10, 50]; 

var TPI_windows = window_size.map(calculate_TPI);

var TPI = ee.ImageCollection
          .fromImages(TPI_windows)
          .toBands()
          .reduce("mean")
          //.multiply(10000)
          //.add(0.5);
          

                     
// Reclassifying landform values into classes

var slope_classes = slope
      .where(slope.gt(-1).and(slope.lte(3)), 1)
      .where(slope.gt(3).and(slope.lte(6)), 2)
      .where(slope.gt(6).and(slope.lte(25)), 3)
      .where(slope.gt(25).and(slope.lte(35)), 4)
      .where(slope.gt(35).and(slope.lte(90)), 5);
     
// It seems Earth engine does not calculate -1 values for flat areas as ArcGis does

var aspect_classes = aspect
      .where(aspect.lte(0), 0)
      .where(aspect.gt(0).and(aspect.lte(90)), 1)
      .where(aspect.gt(90).and(aspect.lte(270)), 2)
      .where(aspect.gt(270).and(aspect.lte(360)), 1);
      
// TPI test, it needs to be checked with the original code

var TPI_classes = TPI
      .where(TPI.lte(-15), 1)
      .where(TPI.gt(-15).and(TPI.lt(-2.5)), 2)
      .where(TPI.gte(-2.5).and(TPI.lte(975)), 3)
      .where(TPI.gt(975), 4);

var moisture_classes = moisture_index
      .where(moisture_index.lte(1400), 0)
      .where(moisture_index.gt(1400), 1);

//var landform = moisture_classes
//                 .where(moisture_classes.eq(0).and(aspect_classes.eq(0)).and(TPI_classes.eq(1)).and(slope_classes.eq(1)), )
                 
      
// Combining classes

var classes_collection = ee.Image([moisture_classes.multiply(ee.Number(1000)), 
                                   aspect_classes.multiply(ee.Number(100)), 
                                   TPI_classes.multiply(ee.Number(10)), 
                                   slope_classes]);

var landform_combination = classes_collection.reduce(ee.Reducer.sum());

var landform_types = landform_combination
                      .where(landform_combination.eq(11), 11)
                      .where(landform_combination.eq(12), 11)
                      .where(landform_combination.eq(13), 13)
                      .where(landform_combination.eq(14), 99)
                      .where(landform_combination.eq(15), 5)
                      .where(landform_combination.eq(21), 21)
                      .where(landform_combination.eq(22), 22)
                      .where(landform_combination.eq(23), 23)
                      .where(landform_combination.eq(24), 99)
                      .where(landform_combination.eq(25), 5)
                      .where(landform_combination.eq(31), 30)
                      .where(landform_combination.eq(32), 32)
                      .where(landform_combination.eq(33), 43)
                      .where(landform_combination.eq(34), 43)
                      .where(landform_combination.eq(35), 5)
                      .where(landform_combination.eq(41), 41)
                      .where(landform_combination.eq(42), 41)
                      .where(landform_combination.eq(43), 99)
                      .where(landform_combination.eq(44), 99)
                      .where(landform_combination.eq(45), 5)
                      .where(landform_combination.eq(111), 11)
                      .where(landform_combination.eq(112), 11)
                      .where(landform_combination.eq(113), 13)
                      .where(landform_combination.eq(114), 3)
                      .where(landform_combination.eq(115), 5)
                      .where(landform_combination.eq(121), 21)
                      .where(landform_combination.eq(122), 22)
                      .where(landform_combination.eq(123), 23)
                      .where(landform_combination.eq(124), 3)
                      .where(landform_combination.eq(125), 5)
                      .where(landform_combination.eq(131), 30)
                      .where(landform_combination.eq(132), 32)
                      .where(landform_combination.eq(133), 43)
                      .where(landform_combination.eq(134), 43)
                      .where(landform_combination.eq(135), 5)
                      .where(landform_combination.eq(141), 41)
                      .where(landform_combination.eq(142), 41)
                      .where(landform_combination.eq(143), 43)
                      .where(landform_combination.eq(144), 3)
                      .where(landform_combination.eq(145), 5)
                      .where(landform_combination.eq(211), 11)
                      .where(landform_combination.eq(212), 11)
                      .where(landform_combination.eq(213), 13)
                      .where(landform_combination.eq(214), 4)
                      .where(landform_combination.eq(215), 5)
                      .where(landform_combination.eq(221), 21)
                      .where(landform_combination.eq(222), 22)
                      .where(landform_combination.eq(223), 24)
                      .where(landform_combination.eq(224), 4)
                      .where(landform_combination.eq(225), 5)
                      .where(landform_combination.eq(231), 30)
                      .where(landform_combination.eq(232), 32)
                      .where(landform_combination.eq(233), 23)
                      .where(landform_combination.eq(234), 4)
                      .where(landform_combination.eq(235), 5)
                      .where(landform_combination.eq(241), 41)
                      .where(landform_combination.eq(242), 41)
                      .where(landform_combination.eq(243), 44)
                      .where(landform_combination.eq(244), 4)
                      .where(landform_combination.eq(245), 5)
                      .where(landform_combination.gt(1000), 39);
                      


//Checking values
/*
var freq = TPI_classes.reduceRegion({reducer: ee.Reducer.frequencyHistogram(), 
                                        geometry: geometry, 
                                        maxPixels: 242845367});

print(freq)
*/
/*
Calculating landform richness within a circular kernel
The circle radius was defined by the TNC area, calculating 100 acre backwards to squared meters, than meters.

r = (A/pi)^1/2

100 acre equal to 404686 squared meters

r = (404686/3.14)^1/2
*/

var r = ee.Number(404686).divide(ee.Number(Math.PI)).sqrt() // radius in meters

var radius_pixels = r.divide(ee.Number(90)).round()

var landform_richness = landform_types.neighborhoodToBands(ee.Kernel.circle(radius_pixels)).reduce(ee.Reducer.countDistinct())
// 9 values
// Visualization

var sld_intervals =
'<RasterSymbolizer>' +
  '<ColorMap type="intervals" extended="false">' +
    '<ColorMapEntry color="#ffc408" quantity="3" label="Cool Steep Slope"/>' +
    '<ColorMapEntry color="#ffa101" quantity="4" label="Warm Steep Slope"/>' +
    '<ColorMapEntry color="#ef595a" quantity="5" label="Cliff"/>' +
    '<ColorMapEntry color="#ffbdbe" quantity="11" label="Summit/Ridgetop"/>' +
    '<ColorMapEntry color="#6e4100" quantity="13" label="Slope Crest"/>' +
    '<ColorMapEntry color="#af7b53" quantity="21" label="Flat Hilltop"/>' +
    '<ColorMapEntry color="#c8c284" quantity="22" label="Gentle Slope Hilltop"/>' +
    '<ColorMapEntry color="#c8f6ad" quantity="23" label="Cool Sideslope"/>' +
    '<ColorMapEntry color="#83e763" quantity="24" label="Warm Sideslope"/>' +
    '<ColorMapEntry color="#ffffbe" quantity="30" label="Dry Flats"/>' +
    '<ColorMapEntry color="#a9a800" quantity="32" label="Valley/Toeslope"/>' +
    '<ColorMapEntry color="#b671f2" quantity="39" label="Moist Flats"/>' +
    '<ColorMapEntry color="#010101" quantity="41" label="Flat at the bottom steep slope"/>' +
    '<ColorMapEntry color="#08a702" quantity="43" label="Cool Footslope/Cove"/>' +
    '<ColorMapEntry color="#0a7000" quantity="44" label="Warm Footslope/Cove"/>' +
    '<ColorMapEntry color="#000000" quantity="99" label="Null"/>' +
  '</ColorMap>' +
'</RasterSymbolizer>';

// Valores de slopes nulos

//var landform_30 = landform_combination.mask(landform_combination.eq(20))

//Map.setCenter(-47.37141, -14.1680, 13); //Plateau

Map.setCenter(-47.20997, -14.05082, 13); //Summits

//Map.setCenter(-46.96556, -13.96459, 13); //hilltops

Map.setCenter(-46.87646, -13.89561, 13); //flat areas to evaluate

Map.addLayer(landform_types.sldStyle(sld_intervals), {});
Map.addLayer(landform_types)
Map.addLayer(TPI)
Map.addLayer(slope)


//Map.addLayer(slope);
//Map.addLayer(TPI.multiply(ee.Number(-1)));

var legend = ui.Panel({
             style: {
               position:'bottom-right',
               padding: '8px 10px'
             }
});

var makeRow = function(color, name) {
 
      // Create the label that is actually the colored box.
      var colorBox = ui.Label({
        style: {
          backgroundColor: color,
          // Use padding to give the box height and width.
          padding: '8px',
          margin: '0 0 4px 0'
        }
      });
 
      // Create the label filled with the description text.
      var description = ui.Label({
        value: name,
        style: {margin: '0 0 4px 6px'}
      });
 
      // return the panel
      return ui.Panel({
        widgets: [colorBox, description],
        layout: ui.Panel.Layout.Flow('horizontal')
      });
};

var palette = [
"#ffc408",
"#ffa101",
"#ef595a",
"#ffbdbe",
"#6e4100",
"#af7b53",
"#c8c284", 
"#c8f6ad",
"#83e763",
"#ffffbe",
"#a9a800",
"#b671f2",
"#010101",
"#08a702",
"#0a7000",
"#000000"];

var land =[
"3-Cool Steep Slope",
"4-Warm Steep Slope",
"5-Cliff",
"11-Summit/Ridgetop",
"13-Slope Crest",
"21-Flat Hilltop",
"22-Gentle Slope Hilltop",
"23-Cool Sideslope",
"24-Warm Sideslope",
"30-Dry Flats",
"32-Valley/Toeslope",
"39-Moist Flats",
"41-Flat at the bottom steep slope",
"43-Cool Footslope/Cove",
"44-Warm Footslope/Cove",
"99"];

for (var i = 0; i < 16; i++) {
  legend.add(makeRow(palette[i], land[i]));
  }  
 
Map.add(legend);


//print(slope.reduceRegion(ee.Reducer.first(), ee.Geometry.Point([-49.71676, -15.54498])))

/*
Export.image.toDrive({
  image: landform_richness,
  description: 'landform_richness',
  scale: 92.76624,
  region: bioma,
  maxPixels: 631694567
});
*/
